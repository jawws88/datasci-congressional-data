with table_one as
(
select
  
  regexp_replace(lower(split_part(recipient_candidate_name, ',', 2) || split_part(recipient_candidate_name, ', ', 1)), '[^a-z]', '', 'g') as re_name_one,
  recipient_candidate_name,
  extract(year from election) as fund_year,
  count(recipient_candidate_name) as num_donations,
  sum(transaction_amount)as total_amount
  
from trg_analytics.candidate_contributions
group by election, recipient_candidate_name
 
),

table_two as
(
select
  
  regexp_replace(lower(split_part(candidate_name, ',', 2) || split_part(candidate_name, ', ', 1)), '[^a-z]', '', 'g') as re_name_two,
  candidate_name, 
  rank() over (partition by contest_name order by vote_total desc) = 1 as is_winner,
  vote_total,
  substring( election_name, 1,4) as dicccser_election_year,
  party_name,
  incumbent_flag
from data_ingest.casos__california_candidate_statewide_election_results
where county_name ilike '%Totals%' 
  and contest_name <> 'President' 
  and contest_name <> 'US Senate - 1'
    
)

select
  
    re_name_one,
    candidate_name as dicccser_name,
    recipient_candidate_name as tacc_name,
    is_winner,
    fund_year,
    dicccser_election_year,
    total_amount,
    vote_total,
    num_donations,
    party_name,
    incumbent_flag
    
from table_two
join table_one
on table_one.re_name_one = table_two.re_name_two
and table_one.fund_year::varchar  = table_two.dicccser_election_year
where re_name_one ilike '%kam%'
order by fund_year asc
  
